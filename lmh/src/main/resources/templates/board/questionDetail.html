<html layout:decorate="~{layout/layout}">
<div layout:fragment="content">
	<div class="container">
		<h2 class="border-bottom py-4" th:text="${question.subject}"></h2>
		<div class="my-3">
			<div class="text-end">
				<button th:if="${isOwner}" id="btnUpdate" class="btn btn-primary">수정</button>
				<button th:if="${isOwner}" id="btnDelete" class="btn btn-danger">삭제</button>
			</div>
		</div>
		<div class="card my-3">
			<div class="card-body">
				<div class="card-text" style="white-space: pre-line; height: 200px;" th:text="${question.content}"></div>
				<div class="d-flex justify-content-end" th:if="${question.lastModifiedDate != null}">
				    <div class="text-end">
						<div class="text-start">
							<div class="mb-1">modified at</div>
					        <div th:text="${#temporals.format(question.lastModifiedDate, 'yyyy-MM-dd HH:mm')}"></div>
						</div>
				    </div>
				</div>
			</div>
		</div>
		<!-- 답변 작성 공간 -->
		<form th:action="@{/answer/create/{id}(id=${question.id})}" method="post" th:object="${answerCreateForm}" class="my-3">
			<textarea sec:authorize="isAnonymous()" disabled th:field="*{content}" class="form-control" rows="5" style="resize: none;"></textarea>
			<textarea sec:authorize="isAuthenticated()" th:field="*{content}" class="form-control" rows="5" style="resize: none;"></textarea>
			<div>
				<div class="text-danger" style="font-size: 0.9rem;" th:if="${#fields.hasErrors('content')}" th:errors="*{content}"></div>
			</div>
			<div class="text-end">
				<input type="submit" value="답변등록" class="btn btn-primary my-2">
				<script th:inline="javascript">
					const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
				</script>
			</div>
		</form>
		<!-- 답변 내용 반복 -->
		<div class="card my-3" th:each="answer : ${answerList}">
			<div class="card-body">
				<div class="card-text" style="white-space: pre-line; height: 50px" th:text="${answer.content}"></div>
				<div class="text-end" style="display: flex; justify-content: flex-end; gap: 4px; color: rgb(0, 128, 192)">
					<div>작성자 :</div>
					<div th:if="${answer.author.username}" th:text="${answer.author.username}"></div>
				</div>
			</div>
		</div>
	</div>
	<div th:if="${message}">
		<script th:inline="javascript">
			/*<![CDATA[*/
			Swal.fire({
				icon: '[[${messageIcon}]]'.replace(/"/g, ''),
				title: '알림',
				text: '[[${message}]]'.replace(/"/g, ''),
				confirmButtonText: '확인',
				allowOutsideClick: false,
				allowEscapeKey: false
			})
			/*]]>*/
		</script>
	</div>
	<script>
		document.addEventListener("DOMContentLoaded", function() {
			const answerForm = document.querySelector("form");
			const submitBtn = answerForm.querySelector('input[type="submit"]');
			
			answerForm.addEventListener("submit", function (e) {
				if (!isAuthenticated) {
					e.preventDefault();
					Swal.fire({
		                icon: "warning",
		                title: "로그인이 필요합니다.",
		                text: "답변을 작성하려면 먼저 로그인하세요.",
		                confirmButtonText: "로그인으로 이동"
		            }).then(result => {
		                if (result.isConfirmed) {
		                    window.location.href = "/user/login";
		                }
		            });
					// 로그인된 상태라면 그대로 submit 실행됨.
				}
			});
			
			if ('[[${isOwner}]]' == 'true') {
				const questionId = '[[${question.id}]]';
				const btnUpdate = document.getElementById("btnUpdate");
				const btnDelete = document.getElementById("btnDelete");
				
				btnUpdate.addEventListener("click", function() {
					  /*<![CDATA[*/
					  Swal.fire({
						title: "수정폼으로 이동하시겠습니까?",
						text: "확인을 누르시면 이동합니다.",
						icon: "question",
						showCancelButton: true,
						confirmButtonColor: "#3085d6",
						cancelButtonColor: "#d33",
						confirmButtonText: "확인",
						cancelButtonText: "취소",
						allowOutsideClick: false,
						allowEscapeKey: false
					  }).then((result) => {
						if (result.isConfirmed) {
							window.location.href = '/question/modify?id=' + questionId;
							
						} else {
							Swal.fire({
								title: "취소되었습니다.",
								icon: "info"
							});
						}
					  });
					  /*]]>*/
				});
				
				btnDelete.addEventListener("click", function() {
					Swal.fire({
						title: "삭제하시겠습니까?",
						text: "버튼을 누르면 게시물이 삭제됩니다.",
						icon: "warning",
						showCancelButton: true,
						confirmButtonColor: "#3085d6",
						cancelButtonColor: "#d33",
						confirmButtonText: "삭제",
						cancelButtonText: "취소",
						allowOutsideClick: false,
						allowEscapeKey: false
					}).then((result) => {
						if (result.isConfirmed) {
							window.location.href = "/question/delete?id=" + questionId; 
						} else {
							Swal.fire({
								title: "취소되었습니다.",
								icon: "info",
								confirmButtonText: "확인",
								allowOutsideClick: false,
								allowEscapeKey: false
							});
						}
					})
				})
			}
			
		});
	</script>
</div>
</html>
